<!doctype>
<html>
<head>
<!--
<script type='text/javascript' src="contractsWeb3.js">
</script>
-->
<script type='text/javascript'
	src="package/compilation/contracts.sol.js">
	
</script>

<script type='text/javascript' src="js/contracts-main.js">
	
</script>

<!-- start of style -->
<link href="style/dapp-styles.css" media="all" rel="stylesheet" />
<style>
.contract {

	border-style: solid;
	border-width: 1px;

}

.contract_attributes {

	border-top-style: solid;
  	border-top-width: 1px;
}

.Struct_Mapping {
	
}

.Value_Mapping {
	
}

.contract_attribute {
	
}

.contract_attribute_value {
	display: inline;
}

.function_execution {
	border-top-style: solid;
  	border-top-width: 1px;
  	width : 100%;
	padding-bottom: 10px;
}

.function_parameter {
	

}

.function_parameter_name{
	margin-top: 24px;
}
.function_button{
	margin-top: 10px;
	margin-left: 25%;
}

.function_result {
	
}
.simple_border {
	border-style: solid;
	border-width: 1px;
	
}
</style>
</head>
<body bgcolor='#E6E6FA'>







	<header class="dapp-header">
		<h1>Issue or Manage Licenses</h1>
	</header>

	<div class="dapp-flex-content">

		<!-- aside -->
		<aside class="dapp-aside">
			<nav>
				<ul>
					<li><a href="#" class="active"
						onclick="lmgf.changeMode('issue')"> <i
							class="icon-arrow-down3"></i> <span>Issuer</span>
					</a> <a href="#" onclick="lmgf.changeMode('manager')"> <i
							class="icon-arrow-up2"></i> <span>Manager</span>
					</a></li>
				</ul>
			</nav>
		</aside>

		<!-- content-->
		<main class="dapp-content">
		<div class="dapp-container">
			<div id="LicenseManager_gui1">  
				<div class="dapp-progress">loading data from contract</div> 
			</div>
		</div>
		</main>
		<!-- actionbar -->
		<aside class="dapp-actionbar">
		</aside>

	</div>




	<script type='text/javascript'>
	
		// if(typeof web3 !== 'undefined')
		//     web3 = new Web3(web3.currentProvider);
		var liContract = web3.eth.contract(JSON.parse(LicenseIssuer.abi));
		//gui factory LicenseManager
		function LicenseManagerGuiFactory1(licenseManager, contract) {
			this.prefix = '';
			this.lm = licenseManager;
			this.issuerContracts = [];
			this.contractData = [];
			this.issuerName = licenseManager.issuerName();
			this.lc = contract;
			this.mode = 'issue';// 'manage'//'issue'

			// reads the data from contract
			this.readDataFromContract = function() {
				this.contractData = [];
				this.issuerContracts = [];
				var cc = this.lm.contractCount();
				for (i = 0; i < cc; i++) {
					var b = lc.contracts(i);
					var sb = this.lc.at(b);
					this.issuerContracts.push(sb);

					data = [ sb.address, sb.licensedItemName(),
							sb.licenseTextHash(), sb.licenseUrl(),
							sb.licencePrice(), sb.licenseLifetime(),
							sb.licenseCount(), sb.issuable() ]

					this.contractData.push(data);
				}
			}

			this.licenceIssueer = function(prefix, itemName, licenseHash,
					licenseUrl, licencePrice, lifeTime, licenseCount, issuable,
					index) {
				return '	  <div class="contract_attributes " id="'+prefix+'LicenseIssuer_contract_attributes">'
						+ '	    <div class="contract_attribute " id="'+prefix+'LicenseIssuer_contract_attribute_licensedItemName"> licensedItemName:'
						+ '	      <div class="contract_attribute_value " id="'+prefix+'LicenseIssuer_licensedItemName_value">'
						+ itemName
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute " id="'+prefix+'LicenseIssuer_contract_attribute_licenseTextHash"> licenseTextHash:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_licenseTextHash_value">'
						+ licenseHash
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute" id="'+prefix+'LicenseIssuer_contract_attribute_licenseUrl"> licenseUrl:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_licenseUrl_value">'
						+ licenseUrl
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute" id="'+prefix+'LicenseIssuer_contract_attribute_licencePrice"> licencePrice:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_licencePrice_value">'
						+ licencePrice
						+ ' wei</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute" id="'+prefix+'LicenseIssuer_contract_attribute_licenseLifetime"> licenseLifetime:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_licenseLifetime_value">'
						+ lifeTime
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute" id="'+prefix+'LicenseIssuer_contract_attribute_licenseCount"> licenseCount:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_licenseCount_value">'
						+ licenseCount
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute" id="'+prefix+'LicenseIssuer_contract_attribute_issuable"> issuable:'
						+ '	      <div class="contract_attribute_value" id="'+prefix+'LicenseIssuer_issuable_value">'
						+ issuable + '</div></div>'

			}

			this.createSubObjects = function() {
				var txt = '';
// 				if (this.mode === 'manager')
// 					txt = txt + this.managerActions();
				
				for (i = 0; i < this.issuerContracts.length; i++) {
					var sb = this.issuerContracts[i];

					d = this.contractData[i];
					txt = txt
							+ this.licenceIssueer(d[0], d[1], d[2], d[3], d[4],
									d[5], d[6], d[7], d[8], i);
					if (this.mode === 'issue')
						txt = txt + this.issuerActions(i,d[0]);
					else
						txt = txt + this.managerActions(i,d[0]);

				}
				return txt;
			}

			// default Gui
			this.placeDefaultGui = function() {
				console.log(this.prefix + ' place gui');
				document.getElementById(this.prefix + 'LicenseManager_gui1').innerHTML = this
						.createDefaultGui();
			}

			this.issuerActions = function(index,prefix) {
				return ''
						+ '	  <div class="function_execution" id="'+prefix+'LicenseIssuer_contract_function_LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32">'
						+ 'CheckLicense by a signed message :'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">factHash</div> <input class="col col-3-4"  type="textArea" id="'+prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_factHash"/></div>'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">v</div>         <input class="col col-3-4" type="number" id="'+prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_v"/></div>'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">sig_r</div>     <input class="col col-3-4" type="text" id="'+prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_sig_r"/></div>'
						+ '		  <div class="function_parameter row clear"><div class="col col-1-4 function_parameter_name">sig_s</div>     <input class="col col-3-4" type="text" id="'+prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_sig_s"/></div>'
						+ '		<button class="dapp-block-button function_button" id="'
						+ prefix
						+ 'LicenseIssuerController.LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32" onclick="'
						+ 'checkLicense_bytes32_uint8_bytes32_bytes32('+index+',\''+prefix +'\')">check License</button>'
						+ '		<div class="function_result" id="'+prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_res"></div>'
						+ '	  </div>'
						+ '	  <div class="function_execution" id="'+prefix+'LicenseIssuer_contract_function_LicenseIssuer_checkLicense_address">'
						+ 'CheckLicense by address:'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">address</div><input class="dapp-address-input col col-3-4" type="text" id="'+prefix+'LicenseIssuer_checkLicense_address__address"></div>'
						+ '		<button class="dapp-block-button function_button"id="'
						+ prefix
						+ 'LicenseIssuerController.LicenseIssuer_checkLicense_address" onclick="checkLicense_address('+index+',\''+ prefix +'\' )">check License</button>'
						+ '		<div class="function_result" id="'+prefix+'LicenseIssuer_checkLicense_address_res"></div>'
						+ '	  </div>'
						+ '	  <div class="function_execution" id="'+prefix+'LicenseIssuer_contract_function_LicenseIssuer_buyLicense_address_string">'
						+ 'Buy a license for an address, when you define no address the address of the sender is used.'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">address</div><input class="dapp-address-input col col-3-4" type="text" id="'+prefix+'LicenseIssuer_buyLicense_address_string__address"></div>'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">name</div><input class="col col-3-4" type="text" id="'+prefix+'LicenseIssuer_buyLicense_address_string__name"></div>'
						+ '		<button class="dapp-block-button function_button" id="'
						+ prefix
						+ 'LicenseIssuerController.LicenseIssuer_buyLicense_address_string" onclick="'
						+ 'buyLicense('+index+',\''+prefix +'\')">buy License</button>'
						+ '		<div class="function_result" id="'+prefix+'LicenseIssuer_buyLicense_address_string_res"></div>'
						+ '	  </div>';

			}

			this.managerActions = function(index,prefix) {
				return '	  <div class="function_execution" id="'+prefix+'LicenseIssuer_contract_function_LicenseIssuer_changePaymentAddress_address">'
						+ 'ChangePaymentAddress:'
						+ '		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">new payment address</div><input class="col col-3-4" type="text" id="'+prefix+'LicenseIssuer_changePaymentAddress_address__newPaymentAddress"></div>'
						+ '		<button class="dapp-block-button function_button"id="'
						+ prefix
						+ 'LicenseIssuerController.LicenseIssuer_changePaymentAddress_address" onclick="changePaymentAddress('+index+',\''+prefix +'\')">change Payment Address</button>'
						+ '		<div class="function_result" id="'+prefix+'LicenseIssuer_changePaymentAddress_address_res"></div>'
						+ '	  </div>'
						+ '	  <div class="function_execution" id="'+prefix+'LicenseIssuer_contract_function_LicenseIssuer_stopIssuing">'
						+ 'StopIssuing:'
						+ '		<button class="dapp-block-button function_button"id="'
						+ prefix
						+ 'LicenseIssuerController.LicenseIssuer_stopIssuing" onclick="'
						+ 'stopIssuing('+index+',\''+prefix +'\')">stop Issuing</button>'
						+ '		<div class="function_result" id="'+prefix+'LicenseIssuer_stopIssuing_res"></div>'
						+ '	  </div>';
			}

			// default Gui
			this.createDefaultGui = function() {
				return '	<div class="contract" id="'+this.prefix+'LicenseManager_contract">'
						+ '	LicenseManager:'
						+ '	  <div class="contract_attributes" id="'+this.prefix+'LicenseManager_contract_attributes">'
						+ '	    <div class="contract_attribute" id="'+this.prefix+'LicenseManager_contract_attribute_issuerName"> issuerName:'
						+ '	      <div class="contract_attribute_value " id="'+this.prefix+'LicenseManager_issuerName_value">'
						+ this.issuerName
						+ '</div>'
						+ '	    </div>'
						+ '	    <div class="contract_attribute " id="'+this.prefix+'LicenseManager_contract_attribute_contractCount"> contractCount:'
						+ '	      <div class="contract_attribute_value " id="'+this.prefix+'LicenseManager_contractCount_value">'
						+ this.issuerContracts.length + '</div>'
						+ '	    </div>'+this.managerAction() + '	  </div>' + this.createSubObjects()
						+ '	</div>';
			}

			this.managerAction = function(){
				var txt = '';
				if (this.mode !== 'issue'){
					txt = 	'	  <div class="function_execution" id="'+this.prefix+'LicenseManager_contract_function_LicenseManager_createIssuerContract_string_string_string_uint_uint">'
					+	'Create IssuerContract. Create a new issuer contract.'
					+	'		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">itemName</div><input class="col col-3-4" type="text" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_itemName"></div>'
					+	'		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">textHash</div><input class="col col-3-4" type="text" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_textHash"></div>'
					+	'		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">url</div><input class="col col-3-4" type="text" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_url"></div>'
					+	'		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">lifeTime</div><input class="col col-3-4" type="number" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_lifeTime"></div>'
					+	'		  <div class="function_parameter row clear "><div class="col col-1-4 function_parameter_name">price</div><input class="col col-3-4" type="number" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_price"></div>'
					+	'		<button class="dapp-block-button function_button"id="'+this.prefix+'LicenseManagerController.LicenseManager_createIssuerContract_string_string_string_uint_uint" onclick="createIssuerContract(\''+this.prefix +'\')">create Issuer Contract</button>'
					+	'		<div class="function_result" id="'+this.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_res"></div>'
					+	'	  </div>'
				}
				return txt;
			}
			
			this.changeMode = function(mode) {
				console.log('change mode to ' + mode);
				this.mode = mode;
				document.getElementById(this.prefix + 'LicenseManager_gui1').innerHTML = '';
				this.placeDefaultGui();
				// for testing
				if (this.mode === 'issue')
					web3.eth.defaultAccount = web3.eth.accounts[1];
				else
					web3.eth.defaultAccount = web3.eth.accounts[0];
				
				console.log(web3.eth.defaultAccount);
			}

			// initalize
// 			this.readDataFromContract();
		}

		web3.eth.defaultAccount = web3.eth.accounts[0];

// 		Gui = function(contract) {
// 			this.contract = contract;
// 			this.prefix = contract.address;
// 			this.price = contract.licencePrice();
// 			var self = this;

// 			this.buyLicense = function() {
// 				var e = document.getElementById(self.prefix
// 						+ 'LicenseIssuer_buyLicense_address_string__address');
// 				var param__address = e.value;
// 				var e = document.getElementById(self.prefix
// 						+ 'LicenseIssuer_buyLicense_address_string__name');
// 				var param__name = e.value;
// 				console.log(':' + self.prefix + ' ' + self.price);
// 				var res = self.contract.buyLicense.sendTransaction(
// 						param__address, param__name, {
// 							value : self.price,
// 							gas : 300000
// 						});
// 			}

// 			this.bindGui = function() {
// 				var btn = document
// 						.getElementById(this.prefix
// 								+ 'LicenseIssuerController.LicenseIssuer_buyLicense_address_string');
// 				console.log('bind:LicenseIssuer_buyLicense ' + this.prefix
// 						+ ' ' + btn + '  ' + this.buyLicense);//LicenseIssuer_buyLicense);
// 				btn.onclick = this.buyLicense;
// 			}

// 		}

		// startup
		var lcContract = web3.eth.contract(JSON.parse(LicenseManager.abi));
		var lc = lcContract.at(contracts['LicenseManager'].address);
		lmgf = new LicenseManagerGuiFactory1(lc, liContract);
		
		//------
		window.onload = function(){
			lmgf.readDataFromContract();
			lmgf.placeDefaultGui();

		};
		
		// actions for the gui
		function stopIssuing(index,prefix){
			console.log('stopp issues:'+lmgf.issuerContracts[index]);
			lmgf.lm.stopIssuing(index);
		}
		
		function checkLicense_address(index,prefix){
			var e = document.getElementById(prefix+'LicenseIssuer_checkLicense_address__address');
			var param__address = e.value;
			var res = lmgf.issuerContracts[index].checkLicense(param__address);
			var target = document.getElementById(prefix+'LicenseIssuer_checkLicense_address_res');
			console.log('checkLicense_address:'+res+' '+prefix+' '+target.id);
			if(res!=null)
				target.innerText = res;
		}
		
		function checkLicense_bytes32_uint8_bytes32_bytes32(index,prefix) {
				var e = document.getElementById(prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_factHash');
				var param_factHash = e.value;
				var e = document.getElementById(prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_v');
				var param_v = e.value;
				var e = document.getElementById(prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_sig_r');
				var param_sig_r = e.value;
				var e = document.getElementById(prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_sig_s');
				var param_sig_s = e.value;
				var res = lmgf.issuerContracts[index].checkLicense(param_factHash, param_v, param_sig_r, param_sig_s);
				if(res!=null)
					document.getElementById(prefix+'LicenseIssuer_checkLicense_bytes32_uint8_bytes32_bytes32_res').innerText = res;
		}
		
		function changePaymentAddress(index,prefix) {
				var e = document.getElementById(prefix+'LicenseIssuer_changePaymentAddress_address__newPaymentAddress');
				var param__newPaymentAddress = e.value;
				console.log(':' +self.LicenseIssuer_instance+':');
				var res = lmgf.issuerContracts[index].changePaymentAddress(param__newPaymentAddress);
		}

		function buyLicense(index,prefix) {
				var e = document.getElementById(prefix+'LicenseIssuer_buyLicense_address_string__address');
				var param__address = e.value;
				var e = document.getElementById(prefix+'LicenseIssuer_buyLicense_address_string__name');
				var param__name = e.value;
				var price = lmgf.contractData[index][4];
				var res = lmgf.issuerContracts[index].buyLicense.sendTransaction(
						param__address, param__name, {
							value : price,
							gas : 300000
						});
				if(res!=null){
					txt = 'The transaction is send: '+res;
					document.getElementById(prefix+'LicenseIssuer_buyLicense_address_string_res').innerText = txt;
				}
		}

		function changePaymentAddress(index,prefix) {
				var e = document.getElementById(prefix+'LicenseIssuer_changePaymentAddress_address__newPaymentAddress');
				var param__newPaymentAddress = e.value;
				var res = lmgf.issuerContracts[index].changePaymentAddress(param__newPaymentAddress);
		}

		function createIssuerContract(prefix){
			//console.log('function:createIssuerContract' + self.prefix);
			var e = document.getElementById(prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_itemName');
//			console.log(':' + self.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_itemName'+": "+e);
			var param_itemName = e.value;
			var e = document.getElementById(prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_textHash');
//			console.log(':' + self.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_textHash'+": "+e);
			var param_textHash = e.value;
			var e = document.getElementById(prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_url');
//			console.log(':' + self.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_url'+": "+e);
			var param_url = e.value;
			var e = document.getElementById(prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_lifeTime');
//			console.log(':' + self.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_lifeTime'+": "+e);
			var param_lifeTime = e.value;
			var e = document.getElementById(prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_price');
//			console.log(':' + self.prefix+'LicenseManager_createIssuerContract_string_string_string_uint_uint_price'+": "+e);
			var param_price = e.value;
//			console.log(':' +self.LicenseManager_instance+':');
			var res = lmgf.lm.createIssuerContract(param_itemName, param_textHash, param_url, param_lifeTime, param_price);

		}
		
	</script>

</body>
</html>
